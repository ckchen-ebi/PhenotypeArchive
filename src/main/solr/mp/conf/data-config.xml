<dataConfig>

	<dataSource name="ds1" jndiName="java:comp/env/jdbc/komp2DataSource" />
	<dataSource name="onto" jndiName="java:comp/env/jdbc/ontodbDataSource" />
    

	<document name="komp2_indexing">
		<!-- test MP:0000180 for multipe node_id being linked to this term -->
		<!-- term infos: ID, name, definition -->
		<entity dataSource="onto" name="mp_term_infos"
			query="select term_id, name, definition from mp_term_infos where term_id != 'MP:0000001'">
			<field column="term_id" name="mp_id" />
			<field column="name" name="mp_term" />
			<field column="definition" name="mp_definition" />

			<!-- subset of this MP term: parsed from obo file -->
			<entity dataSource="onto" name="mp_term_subsets"
				query="select subset from mp_term_subsets where term_id='${mp_term_infos.term_id}'">
				<field column="subset" name="ontology_subset" />
			</entity>

			<!-- synonym of this MP term -->
			<entity dataSource="onto" name="mp_synonyms"
				query="select syn_name from mp_synonyms where term_id = '${mp_term_infos.term_id}'">
				<field column="syn_name" name="mp_term_synonym" />
			</entity>

			<!-- GO association of MP term -->
			<entity dataSource="onto" name="mp_dbxrefs"
				query="select xref_id from mp_dbxrefs where term_id='${mp_term_infos.term_id}' and xref_id like 'GO:%'">
				<field column="xref_id" name="go_id" />
			</entity>

			<!-- MP-MA relationship; MA term has no definition -->
			<entity dataSource="onto" name="mp_mappings" onError="continue"
				query="select mapped_term_id from mp_mappings where term_id='${mp_term_infos.term_id}' and ontology='MA'">
				<field column="mapped_term_id" name="ma_id" />
				<entity dataSource="onto" name="ma_term_infos"
					query="select name from ma_term_infos where term_id='${mp_mappings.mapped_term_id}'">
					<field column="name" name="ma_term" />
				</entity>
			</entity>

			<!-- top level MP term of this MP term -->
			<entity dataSource="onto" name="mp_node2term"
				query="select node_id from mp_node2term where term_id='${mp_term_infos.term_id}'">
				<entity dataSource="onto" name="mp_node_top_level"
					query="select top_level_node_id from mp_node_top_level where node_id=${mp_node2term.node_id}">
					<entity dataSource="onto" name="mp_node2term"
						query="select term_id from mp_node2term where node_id=${mp_node_top_level.top_level_node_id}">
						<entity dataSource="onto" name="mp_term_infos"
							query="select term_id, name, definition from mp_term_infos where term_id='${mp_node2term.term_id}' and term_id != 'MP:0000001'">

							<!-- do not want to include the root term -->
							<field column="term_id" name="top_level_mp_id" />
							<field column="name" name="top_level_mp_term" />
							<field column="definition" name="top_level_mp_definition" />
						</entity>
					</entity>
				</entity>
			</entity>

			<!-- child MP term of this MP term -->
			<entity dataSource="onto" name="mp_node2term"
				query="select node_id from mp_node2term where term_id='${mp_term_infos.term_id}'">
				<entity dataSource="onto" name="mp_parent_children" onError="continue"
					query="select parent_node_id, child_node_id from mp_parent_children where child_node_id=${mp_node2term.node_id}">
					<entity dataSource="onto" name="mp_parent_children"
						query="select child_node_id from mp_parent_children where parent_node_id=${mp_parent_children.parent_node_id}">
						<entity dataSource="onto" name="mp_node2term"
							query="select term_id from mp_node2term where node_id=${mp_parent_children.child_node_id}">

							<!-- only index child term that has mp annotation -->
							<entity dataSource="ds1" onError="continue" name="phenotype_call_summary"
								query="select count(*) from phenotype_call_summary where mp_acc='${mp_node2term.term_id}'">
								<entity dataSource="onto" name="mp_term_infos"
									query="select term_id, name, definition from mp_term_infos where term_id='${mp_node2term.term_id}'">
									<field column="term_id" name="child_mp_id" />
									<field column="name" name="child_mp_term" />
									<field column="definition" name="child_mp_definition" />
								</entity>
							</entity>
						</entity>
					</entity>
				</entity>
			</entity>

			<!-- whether this MP has annotated phenotype images -->
			<entity dataSource="onto" onError="continue" name="mp_with_pheno_image"
				query="select term_id from mp_with_pheno_image where term_id='${mp_term_infos.term_id}'">
				<field column="term_id" name="mp_with_pheno_image" />
			</entity>

			<!-- MGI genes annotated to this MP term which has pipeline/procedure and allele/strain infos -->
			<entity dataSource="ds1" name="phenotype_call_summary"
				query="select 
					ppipe.stable_key as pipeline_stable_key, ppipe.name as pipeline_name, ppipe.stable_id as pipeline_stable_id, 
					pproc.stable_key as procedure_stable_key, pproc.name as procedure_name, pproc.stable_id as procedure_stable_id, 
					pparam.stable_key as parameter_stable_key, pparam.name as parameter_name, pparam.stable_id as parameter_stable_id, 
					strain.name as strain_name, allele.symbol as allele_symbol, gf.acc as gene_acc, gf.symbol as gene_symbol, 
					pcs.external_id, pcs.gf_acc, pcs.procedure_id, pcs.parameter_id, pcs.pipeline_id, pcs.allele_acc, pcs.strain_acc, pcs.sex, pcs.zygosity 
					from phenotype_call_summary pcs
					LEFT OUTER JOIN genomic_feature gf ON gf.acc=pcs.gf_acc
					LEFT OUTER JOIN allele ON allele.acc=pcs.allele_acc
					LEFT OUTER JOIN strain ON allele.acc=pcs.allele_acc
					LEFT OUTER JOIN phenotype_pipeline ppipe ON allele.acc=pcs.allele_acc
					LEFT OUTER JOIN phenotype_procedure pproc ON allele.acc=pcs.allele_acc
					LEFT OUTER JOIN phenotype_parameter pparam ON pparam.id=pcs.parameter_id
					where pcs.mp_acc='${mp_term_infos.term_id}' 
					and pcs.gf_db_id=3 
					and pcs.gf_acc like 'MGI:%' 
					and pcs.allele_acc is not null 
					and pcs.strain_acc is not null">
				<field column="external_id" name="external_id" />
				<field column="sex" name="sex" />
				<field column="zygosity" name="zygosity" />
				<field column="allele_acc" name="allele_id" />
				<field column="strain_acc" name="strain_id" />

				<field column="gene_symbol" name="marker_symbol" />
				<field column="gene_acc" name="mgi_accession_id" />

				<field column="allele_symbol" name="allele_symbol" />

				<field column="strain_name" name="strain_name" />

				<field column="pipeline_stable_id" name="pipeline_stable_id" />
				<field column="pipeline_name" name="pipeline_name" />
				<field column="pipeline_stable_key" name="pipeline_stable_key" />

				<field column="procedure_name" name="procedure_name" />
				<field column="procedure_stable_id" name="procedure_stable_id" />
				<field column="procedure_stable_key" name="procedure_stable_key" />

				<field column="parameter_name" name="parameter_name" />
				<field column="parameter_stable_id" name="parameter_stable_id" />
				<field column="parameter_stable_key" name="parameter_stable_key" />
			</entity>

						
		</entity>
	</document>

</dataConfig>
